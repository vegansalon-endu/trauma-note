import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, deleteDoc, doc } from 'firebase/firestore';


// --- Firebase Configuration ---
// ★★★ 修正点：あなたのFirebase設定を正しく反映しました ★★★
const firebaseConfig = {
  apiKey: "AIzaSyB_rMN1UeLQCd8Okk3pXZLekYqwbXtVJcM",
  authDomain: "trauma-note-app-abf7e.firebaseapp.com",
  projectId: "trauma-note-app-abf7e",
  storageBucket: "trauma-note-app-abf7e.appspot.com",
  messagingSenderId: "143251018612",
  appId: "1:143251018612:web:abb58f483269f519851221",
  measurementId: "G-5G196KQY3S"
};


const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');


    const db = useRef(null);
    const auth = useRef(null);


    // --- Firebase Initialization and Authentication ---
    useEffect(() => {
        try {
            // ★★★ 修正点：重複していた初期化を削除し、一箇所にまとめました ★★★
            const app = initializeApp(firebaseConfig);
            auth.current = getAuth(app);
            db.current = getFirestore(app);


            onAuthStateChanged(auth.current, (user) => {
                if (user) {
                    setUser(user);
                    setLoading(false);
                } else {
                    signInAnonymously(auth.current).catch(err => {
                        console.error("Anonymous sign-in failed:", err);
                        setError("認証に失敗しました。ページを再読み込みしてください。");
                        setLoading(false);
                    });
                }
            });
        } catch (e) {
            console.error("Firebase initialization error:", e);
            setError("システムの初期化に失敗しました。");
            setLoading(false);
        }
    }, []);


    // --- Firestore Data Fetching ---
    useEffect(() => {
        if (user && db.current) {
            const notesCollectionPath = `/artifacts/${appId}/users/${user.uid}/trauma_notes`;
            const q = query(collection(db.current, notesCollectionPath), orderBy('createdAt', 'desc'));


            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const notesData = [];
                querySnapshot.forEach((doc) => {
                    notesData.push({ id: doc.id, ...doc.data() });
                });
                setNotes(notesData);
            }, (err) => {
                console.error("Error fetching notes:", err);
                setError("ノートの読み込みに失敗しました。");
            });


            return () => unsubscribe();
        }
    }, [user]);


    // --- Event Handlers ---
    const handleAddNote = async (e) => {
        e.preventDefault();
        if (newNote.trim() === '' || !user || !db.current) return;


        try {
            const notesCollectionPath = `/artifacts/${appId}/users/${user.uid}/trauma_notes`;
            await addDoc(collection(db.current, notesCollectionPath), {
                text: newNote,
                createdAt: serverTimestamp()
            });
            setNewNote('');
        } catch (err) {
            console.error("Error adding note:", err);
            setError("ノートの保存に失敗しました。");
        }
    };
   
    const handleDeleteNote = async (noteId) => {
        if (!user || !db.current || !noteId) return;
        const notePath = `/artifacts/${appId}/users/${user.uid}/trauma_notes/${noteId}`;
        try {
            await deleteDoc(doc(db.current, notePath));
        } catch (err) {
            console.error("Error deleting note:", err);
            setError("ノートの削除に失敗しました。");
        }
    };


    // --- Render Logic ---
    if (loading) {
        return (
            <div className="flex justify-center items-center h-screen" style={{backgroundColor: '#F8F7F5'}}>
                <div className="text-center">
                     <div className="w-12 h-12 border-4 border-pink-200 rounded-full loader mx-auto" style={{borderTopColor: '#E9A4B8'}}></div>
                     <p className="mt-4 text-lg" style={{color: '#4E4E4E'}}>接続中...</p>
                </div>
            </div>
        );
    }


    return (
        <div className="min-h-screen p-4 sm:p-8" style={{backgroundColor: '#F8F7F5', color: '#4E4E4E'}}>
            <div className="max-w-2xl mx-auto">
                <header className="text-center mb-10">
                    <h1 className="text-3xl sm:text-4xl font-semibold" style={{fontFamily: "'Noto Serif JP', serif"}}>
                        トラウマノート
                    </h1>
                    <p className="mt-2 text-sm">安心して、あなたの感情を書き出しましょう。</p>
                </header>
               
                {error && <p className="text-red-500 bg-red-100 p-3 rounded-lg mb-4">{error}</p>}


                <main>
                    <form onSubmit={handleAddNote} className="mb-8 p-6 bg-white rounded-lg shadow-sm">
                        <h2 className="text-xl font-semibold mb-4" style={{fontFamily: "'Noto Serif JP', serif"}}>新しいノート</h2>
                        <textarea
                            value={newNote}
                            onChange={(e) => setNewNote(e.target.value)}
                            placeholder="今、感じていることを、そのまま言葉にしてみてください..."
                            className="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2"
                            style={{"--tw-ring-color": '#E9A4B8'}}
                        />
                        <div className="text-right mt-4">
                            <button
                                type="submit"
                                className="text-white font-bold py-2 px-6 rounded-full shadow-lg hover:opacity-90 transition-transform transform hover:scale-105"
                                style={{backgroundColor: '#E9A4B8'}}
                                disabled={!newNote.trim()}
                            >
                                保存する
                            </button>
                        </div>
                    </form>


                    <div className="space-y-6">
                         <h2 className="text-xl font-semibold border-b-2 pb-2" style={{fontFamily: "'Noto Serif JP', serif", borderColor: '#E9A4B8'}}>過去のノート</h2>
                         {notes.length === 0 ? (
                            <p className="text-center text-gray-500 py-8">まだノートはありません。</p>
                         ) : (
                            <ul className="space-y-4">
                                {notes.map((note) => (
                                    <li key={note.id} className="bg-white p-5 rounded-lg shadow-sm relative group">
                                        <p className="whitespace-pre-wrap leading-relaxed">{note.text}</p>
                                        <p className="text-xs text-gray-400 mt-3 text-right">
                                            {note.createdAt?.toDate().toLocaleString('ja-JP')}
                                        </p>
                                        <button
                                            onClick={() => handleDeleteNote(note.id)}
                                            className="absolute top-2 right-2 p-1 rounded-full bg-gray-200 text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                            aria-label="削除"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </li>
                                ))}
                            </ul>
                         )}
                    </div>
                </main>
            </div>
        </div>
    );
}