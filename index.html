import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion } from 'firebase/firestore';


// --- Firebase Configuration ---
const firebaseConfig = typeof __firebase_config !== 'undefined'
    ? JSON.parse(__firebase_config)
    : { apiKey: "AIzaSyB_rMN1UeLQCd8Okk3pXZLekYqwbXtVJcM", authDomain: "trauma-note-app-abf7e.firebaseapp.com", projectId: "trauma-note-app-abf7e" };


const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
   
    // For AI Chat Modal
    const [isChatOpen, setIsChatOpen] = useState(false);
    const [currentNote, setCurrentNote] = useState(null);
    const [chatHistory, setChatHistory] = useState([]);
    const [isAiThinking, setIsAiThinking] = useState(false);
    const [chatInput, setChatInput] = useState('');


    const db = useRef(null);
    const auth = useRef(null);
    const chatEndRef = useRef(null);


    // --- Firebase Initialization and Authentication ---
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            auth.current = getAuth(app);
            db.current = getFirestore(app);


            onAuthStateChanged(auth.current, (user) => {
                if (user) {
                    setUser(user);
                } else {
                    signInAnonymously(auth.current).catch(err => {
                        console.error("Anonymous sign-in failed:", err);
                        setError("認証に失敗しました。ページを再読み込みしてください。");
                    });
                }
                setLoading(false);
            });
        } catch (e) {
            console.error("Firebase initialization error:", e);
            setError("システムの初期化に失敗しました。");
            setLoading(false);
        }
    }, []);


    // --- Firestore Data Fetching ---
    useEffect(() => {
        if (user && db.current) {
            const notesCollectionPath = `/artifacts/${appId}/users/${user.uid}/trauma_notes`;
            const q = query(collection(db.current, notesCollectionPath), orderBy('createdAt', 'desc'));


            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const notesData = [];
                querySnapshot.forEach((doc) => {
                    notesData.push({ id: doc.id, ...doc.data() });
                });
                setNotes(notesData);
            }, (err) => {
                console.error("Error fetching notes:", err);
                setError("ノートの読み込みに失敗しました。");
            });


            return () => unsubscribe();
        }
    }, [user]);
   
    // --- Scroll to bottom of chat ---
    useEffect(() => {
        if (chatEndRef.current) {
            chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [chatHistory]);




    // --- Event Handlers ---
    const handleAddNote = async (e) => {
        e.preventDefault();
        if (newNote.trim() === '' || !user || !db.current) return;
        try {
            const notesCollectionPath = `/artifacts/${appId}/users/${user.uid}/trauma_notes`;
            await addDoc(collection(db.current, notesCollectionPath), {
                text: newNote,
                createdAt: serverTimestamp(),
                chat: [] // Initialize chat history
            });
            setNewNote('');
        } catch (err) {
            console.error("Error adding note:", err);
            setError("ノートの保存に失敗しました。");
        }
    };
   
    const handleDeleteNote = async (noteId) => {
        if (!user || !db.current || !noteId) return;
        const notePath = `/artifacts/${appId}/users/${user.uid}/trauma_notes/${noteId}`;
        try {
            await deleteDoc(doc(db.current, notePath));
        } catch (err) {
            console.error("Error deleting note:", err);
            setError("ノートの削除に失敗しました。");
        }
    };
   
    // --- AI Chat Functions ---
    const openChat = (note) => {
        setCurrentNote(note);
        setChatHistory(note.chat || []);
        setIsChatOpen(true);
    };


    const closeChat = () => {
        setIsChatOpen(false);
        setCurrentNote(null);
        setChatHistory([]);
    };


    const handleChatSubmit = async (e) => {
        e.preventDefault();
        if(chatInput.trim() === '' || isAiThinking) return;


        const newUserMessage = { role: 'user', text: chatInput };
        const updatedChatHistory = [...chatHistory, newUserMessage];
        setChatHistory(updatedChatHistory);
        setChatInput('');
        setIsAiThinking(true);


        try {
            const prompt = createChatPrompt(currentNote.text, updatedChatHistory);
            const aiResponse = await generateAiResponse(prompt);
            const newAiMessage = { role: 'ai', text: aiResponse };
           
            setChatHistory([...updatedChatHistory, newAiMessage]);


            const noteRef = doc(db.current, `/artifacts/${appId}/users/${user.uid}/trauma_notes/${currentNote.id}`);
            await updateDoc(noteRef, {
                chat: arrayUnion(newUserMessage, newAiMessage)
            });


        } catch (err) {
            console.error("AI chat error:", err);
            const errorMessage = { role: 'ai', text: '申し訳ありません、エラーが発生しました。もう一度試してみてください。' };
            setChatHistory([...updatedChatHistory, errorMessage]);
        } finally {
            setIsAiThinking(false);
        }
    };


    const createChatPrompt = (initialNote, history) => {
        const historyText = history.map(msg => `${msg.role === 'user' ? 'あなた' : 'AI'}: ${msg.text}`).join('\n');
        return `
あなたは、トラウマノートの専門カウンセラーです。あなたの目的は、ユーザーが自分の感情の根本原因を探る手助けをすることです。決して答えを与えたり、解釈をしたりせず、優しく、短い、開かれた質問を一つだけ投げかけることで、ユーザー自身の気づきを促してください。


# ユーザーの最初のノート
「${initialNote}」


# これまでの対話
${historyText}


# あなたの次の行動
上記の対話をふまえ、ユーザーがさらに深く自分の内面を探求できるような、**共感的で、短い、一つの質問だけ**を返してください。
例：「そのように感じた時、他に何か心に浮かんだことはありましたか？」「その『いやな感じ』は、体のどこかで感じましたか？」
`;
    };


    const generateAiResponse = async (prompt) => {
        const apiKey = "AIzaSyAdjWYPpgAnLfIflzpTBth1N5NN1_qHa0E";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });
        if (!response.ok) throw new Error(`AI APIエラー: ${response.statusText}`);
        const result = await response.json();
        return result.candidates[0].content.parts[0].text;
    };




    // --- Render Logic ---
    if (loading) {
        return (
            <div className="flex justify-center items-center h-screen" style={{backgroundColor: '#F8F7F5'}}>
                <div className="text-center">
                     <div className="w-12 h-12 border-4 border-pink-200 rounded-full loader mx-auto" style={{borderTopColor: '#E9A4B8'}}></div>
                     <p className="mt-4 text-lg" style={{color: '#4E4E4E'}}>接続中...</p>
                </div>
            </div>
        );
    }


    return (
        <div className="min-h-screen p-4 sm:p-8" style={{backgroundColor: '#F8F7F5', color: '#4E4E4E'}}>
            <div className="max-w-2xl mx-auto">
                <header className="text-center mb-10">
                    {/* ★★★ 変更点 ★★★ */}
                    <h1 className="text-3xl sm:text-4xl font-semibold" style={{fontFamily: "'Noto Serif JP', serif"}}>
                        トラウマノート (試験版 v1.1)
                    </h1>
                    <p className="mt-2 text-sm">安心して、あなたの感情を書き出しましょう。</p>
                </header>
               
                {error && <p className="text-red-500 bg-red-100 p-3 rounded-lg mb-4">{error}</p>}


                <main>
                    <form onSubmit={handleAddNote} className="mb-8 p-6 bg-white rounded-lg shadow-sm">
                        <h2 className="text-xl font-semibold mb-4" style={{fontFamily: "'Noto Serif JP', serif"}}>新しいノート</h2>
                        <textarea
                            value={newNote}
                            onChange={(e) => setNewNote(e.target.value)}
                            placeholder="今、感じていることを、そのまま言葉にしてみてください..."
                            className="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2"
                            style={{"--tw-ring-color": '#E9A4B8'}}
                        />
                        <div className="text-right mt-4">
                            <button
                                type="submit"
                                className="text-white font-bold py-2 px-6 rounded-full shadow-lg hover:opacity-90 transition-transform transform hover:scale-105 disabled:opacity-50"
                                style={{backgroundColor: '#E9A4B8'}}
                                disabled={!newNote.trim()}
                            >
                                保存する
                            </button>
                        </div>
                    </form>


                    <div className="space-y-6">
                         <h2 className="text-xl font-semibold border-b-2 pb-2" style={{fontFamily: "'Noto Serif JP', serif", borderColor: '#E9A4B8'}}>過去のノート</h2>
                         {notes.length === 0 ? (
                            <p className="text-center text-gray-500 py-8">まだノートはありません。</p>
                         ) : (
                            <ul className="space-y-4">
                                {notes.map((note) => (
                                    <li key={note.id} className="bg-white p-5 rounded-lg shadow-sm group">
                                        <div className="flex justify-between items-start">
                                            <p className="whitespace-pre-wrap leading-relaxed flex-1">{note.text}</p>
                                            <button
                                                onClick={() => handleDeleteNote(note.id)}
                                                className="ml-4 p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors"
                                                aria-label="削除"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div className="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                                            <p className="text-xs text-gray-400">
                                                {note.createdAt?.toDate().toLocaleString('ja-JP')}
                                            </p>
                                            <button
                                                onClick={() => openChat(note)}
                                                className="text-sm font-semibold py-1 px-3 rounded-full hover:opacity-90 transition"
                                                style={{color: '#9d2667', backgroundColor: 'rgba(233, 164, 184, 0.2)'}}
                                            >
                                                AIとこの感情を深掘りする
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                         )}
                    </div>
                </main>
            </div>
           
            {isChatOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col" style={{height: '80vh'}}>
                        <header className="p-4 border-b flex justify-between items-center">
                            <h2 className="text-lg font-semibold" style={{fontFamily: "'Noto Serif JP', serif"}}>AIとの対話</h2>
                            <button onClick={closeChat} className="p-1 rounded-full hover:bg-gray-200">&times;</button>
                        </header>
                        <div className="flex-1 p-4 overflow-y-auto space-y-4">
                            {chatHistory.map((msg, index) => (
                                <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msg.role === 'user' ? 'bg-pink-100 text-right' : 'bg-gray-100'}`}>
                                        <p className="whitespace-pre-wrap">{msg.text}</p>
                                    </div>
                                </div>
                            ))}
                            {isAiThinking && (
                                <div className="flex justify-start">
                                    <div className="bg-gray-100 px-4 py-2 rounded-2xl">
                                        <span className="animate-pulse">...</span>
                                    </div>
                                </div>
                            )}
                            <div ref={chatEndRef} />
                        </div>
                        <footer className="p-4 border-t">
                            <form onSubmit={handleChatSubmit} className="flex space-x-2">
                                <input
                                    type="text"
                                    value={chatInput}
                                    onChange={(e) => setChatInput(e.target.value)}
                                    placeholder="気持ちを言葉にしてみましょう..."
                                    className="flex-1 p-2 border border-gray-300 rounded-full focus:ring-2"
                                    style={{"--tw-ring-color": '#E9A4B8'}}
                                    disabled={isAiThinking}
                                />
                                <button
                                    type="submit"
                                    className="text-white font-bold w-10 h-10 rounded-full flex items-center justify-center transition"
                                    style={{backgroundColor: '#E9A4B8'}}
                                    disabled={!chatInput.trim() || isAiThinking}
                                >
                                    &uarr;
                                </button>
                            </form>
                        </footer>
                    </div>
                </div>
            )}
        </div>
    );
}